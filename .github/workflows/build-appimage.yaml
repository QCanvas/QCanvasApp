name: build
on:
    #    create:
    push:
        branches:
            - "reborn"

jobs:
    build-appimage:
        name: Build Appimage
        runs-on: ubuntu-22.04
        steps:
            -   run: sudo apt install desktop-file-utils -y
            -   uses: actions/checkout@v4
            -   run: wget https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-x86_64.AppImage -O appimagetool
            -   run: chmod +x appimagetool
            -   uses: actions/setup-python@v5
                with:
                    python-version: 3.11.9
            -   name: Install poetry
                uses: abatilo/actions-poetry@v2
            -   name: Install deps
                run: poetry install
            -   name: Build pyinstaller
                run: poetry run pyinstaller --hidden-import aiosqlite --onedir -n AppRun qcanvas/run.py
            -   name: Move files
                run: mv dist/*/* appimage/
            -   name: Package AppImage
                run: ./appimagetool appimage -u "gh-releases-zsync|QCanvas|QCanvasApp|latest|QCanvas-x86_64.AppImage.zsync"
            #            -   uses: actions/upload-artifact@v4
            #                with:
            #                    path: |
            #                        QCanvas-x86_64.AppImage
            #                        QCanvas-x86_64.AppImage.zsync
            -   run: echo "DATE=$(date +'%d-%m-%Y')" >> $GITHUB_ENV
            -   name: Upload binaries to release
                uses: svenstaro/upload-release-action@v2
                with:
                    release_name: "Build ${{ env.DATE }}"
                    repo_token: ${{ secrets.PUBLISH_TOKEN }}
                    file: QCanvas-*
                    tag: "prerelease-${{ env.DATE }}"
                    overwrite: true
                    file_glob: true
            -   run: echo ${{env.GITHUB_REF}}
    build-windows:
        name: Build PyInstaller Windows
        runs-on: windows-latest
        steps:
            -   uses: actions/checkout@v4
            -   uses: actions/setup-python@v5
                with:
                    python-version: 3.11.9
            -   name: Install poetry
                uses: abatilo/actions-poetry@v2
            -   name: Install deps
                run: poetry install
            -   name: Build pyinstaller
                run: poetry run pyinstaller --hidden-import aiosqlite --onefile -n QCanvas --icon windows/qcanvas.ico qcanvas/run.py #--windowed
            -   name: Get time
                uses: Kaven-Universe/github-action-current-date-time@v1
                id: get_time
                with:
                    format: "DD-MM-YYYY"
            -   name: Upload binaries to release
                uses: svenstaro/upload-release-action@v2
                with:
                    release_name: "Build ${{ steps.get_time.outputs.time }}"
                    repo_token: ${{ secrets.PUBLISH_TOKEN }}
                    file: dist/QCanvas.exe
                    tag: "prerelease-${{ steps.get_time.outputs.time }}"
                    overwrite: true
